# Spring Boot for Data

# [Data](https://docs.spring.io/spring-boot/docs/current/reference/html/data.html)

## SQL

### Embedded Database 
- h2
- HSQL
- Derby 
- 
### [Data Source](https://github.com/spring-projects/spring-boot/blob/v2.7.3/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/jdbc/DataSourceProperties.java)
Properties: *spring.datasource.\**: url,username,password,driver-class-name
Fine Tunning for connection pool: *spring.datasource.hikari.\*, spring.datasource.tomcat.\*, spring.datasource.dbcp2.\*, and spring.datasource.oracleucp.\**

### Using JdbcTemplate
Auto-configure *JdbcTemplate* and *NamedParameterJdbcTemplate* with *spring.jdbc.template.\**, can @Autowire them directly into the beans:
```
@Component
public class MyBean {
    private final JdbcTemplate jdbcTemplate;
    public MyBean(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }
    public void doSomething() {
        this.jdbcTemplate ...
    }
}
```
### JPA and Spring Data JPA
- Hibernate
- Spring Data
- Spring ORM

#### Entity (model)
Any classes annotated with @Entity, @Embeddable, or @MappedSuperclass below the main configuration class (annotated with @EnableAutoConfiguration or @SpringBootApplication) are searched.

When working with JPA and Lombok:
- Avoid using @EqualsAndHashCode and @Data with JPA entities;
- Exclude lazy attributes when using @ToString;
- Add @NoArgsConstructor to entities with @Builder or @AllArgsConstructor, for all entity classes are required to have a public or protected no-argument constructor

@EqualsAndHashCode: uses all non-static, non-transient fields, and can be customized by @EqualsAndHashCode.Include or @EqualsAndHashCode.Exclude.
Equals()/hashCode() implementation for JPA entities is a sensitive subject. Naturally, entities are mutable. Even the id of an entity is often generated by a database, so it gets changed after the entity is first persisted. This means there are no fields we can rely on to calculate the hashCode.

 @ToString:  By default, it'll print your class name, along with each field, in order, separated by commas. These methods call equals()/hashCode()/toString() on every field of an object. This can have an unwanted side-effect for JPA entities: accidentally loading lazy attributes, such as calling hashCode() on a lazy @OneToMany may fetch all the entities it contains.  Place @ToString.Exclude on the lazy loading fields. 
 
```
import java.io.Serializable;
import javax.persistence.*;

import javax.validation.constraints.NotEmpty;

import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;
import lombok.Getter;
import lombok.Setter;
import lombok.experimental.Accessors;

@Entity
@Table(name="city")
@NoArgsConstructor
@AllArgsConstructor 
@Accessors(chain=true)
@Getter
@Setter
@ToString
public class City implements Serializable {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    @NotEmpty(message = "Name is required")
    private String name;

    @Column(nullable = false)
    private String state;

    // ... additional members, often include @OneToMany mappings
    @ToString.Exclusive
    @OneToMany
    private Ste<Pet> pets;    
}
```

#### Data JPA Repositories (dao)
Spring Data repositories usually extend from the Repository or CrudRepository interfaces:
- CrudRepository mainly provides CRUD functions.
- PagingAndSortingRepository: extends CrudRepository, provides methods to do pagination and sorting records.
- JpaRepository: extends PagingAndSortingRepository, provides some JPA-related methods such as flushing the persistence context and deleting records in a batch.

```
import java.util.Optional;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface CityRepository extends Repository<City, Long> {
    Page<City> findAll(Pageable pageable);
    City findByNameAndStateAllIgnoringCase(String name, String state);
}
```
JPA repositories support three different modes of bootstrapping: **default,deferred,lazy**. To enable deferred or lazy bootstrapping, set the *spring.data.jpa.repositories.bootstrap-mode* property to deferred or lazy respectively.

#### Envers: provide an easy auditing / versioning solution for entity classes.
- [Hibernate ORM Envers](https://hibernate.org/orm/envers/)
Hibernate Envers uses revisioing. A revision identifies a collection of changes to entities and their associations for all audited attributes that occured within the boundary of a transaction. These revisions are global and numeric.
```
@Entity
public class Person {
    @Id
    @GeneratedValue
    private Integer id;

    @Audited
    private String name;

    @Audited
    private String surname;

    @Audited
    @ManyToOne
    private Address address;
}
```
- [Spring Envers](https://docs.spring.io/spring-data/envers/docs/current/reference/html/)
Uses RevisionRepository:
```
public interface CountryRepository extends RevisionRepository<Country, Long, Integer>, Repository<Country, Long> {
    Page<Country> findAll(Pageable pageable);
}
```
Misc properties:
```
spring.jpa.hibernate.ddl-auto=create-drop  # default created only for embedded db
spring.jpa.properties.hibernate[globally_quoted_identifiers]=true  # for Hibernate's intrenal properties
spring.jpa.open-in-view=false #disable lazy loading in web views
```
#### Data JDBC
Use **CrudRepository** and **@Query**; Config with **spring-boot-starter-data-jdbc/@EnableJdbcRepositories/JdbcConfiguration**.

### H2 Web Console
Configuration:
```
spring.h2.console.enabled=true/false
spring.h2.console.path=/h2-console
```
Security needs to be set in Secured Application:
```
import org.springframework.boot.autoconfigure.security.servlet.PathRequest;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Profile;
import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.security.config.Customizer;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.web.SecurityFilterChain;

@Profile("dev")
@Configuration(proxyBeanMethods = false)
public class DevProfileSecurityConfiguration {
    @Bean
    @Order(Ordered.HIGHEST_PRECEDENCE)
    SecurityFilterChain h2ConsoleSecurityFilterChain(HttpSecurity http) throws Exception {
        http.requestMatcher(PathRequest.toH2Console());
        http.authorizeRequests(yourCustomAuthorization());
        http.csrf((csrf) -> csrf.disable());
        http.headers((headers) -> headers.frameOptions().sameOrigin());
        return http.build();
    }
}
```
### jOOQ: Generate Java code from database
- Code Generation via jooq-codegen-maven
- Using DSLContext
```
import java.util.GregorianCalendar;
import java.util.List;

import org.jooq.DSLContext;
import org.springframework.stereotype.Component;
import static org.springframework.boot.docs.data.sql.jooq.dslcontext.Tables.AUTHOR;

@Component
public class MyBean {
    private final DSLContext create;
    public MyBean(DSLContext dslContext) {
        this.create = dslContext;
    }
}
```
### R2DBC
- Configuration
Reactive Relational Database Connectivity (R2DBC) brings reactive programming APIs to relational databases. R2DBC’s io.r2dbc.spi.Connection provides a standard method of working with non-blocking database connections. Connections are provided by using a ConnectionFactory (similar to DataSource in jdbc). ConnectionFactory configuration is controlled by properties in *spring.r2dbc.\** (No needthe driver class name).
```
spring.r2dbc.url=r2dbc:postgresql://localhost/test
spring.r2dbc.username=dbuser
spring.r2dbc.password=dbpass
```
To customize the connection created by a ConnectionFactory:
```
import io.r2dbc.spi.ConnectionFactoryOptions;
import org.springframework.boot.autoconfigure.r2dbc.ConnectionFactoryOptionsBuilderCustomizer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration(proxyBeanMethods = false)
public class MyR2dbcConfiguration {
    @Bean
    public ConnectionFactoryOptionsBuilderCustomizer connectionFactoryPortCustomizer() {
         //setup options
         return (builder) -> builder.option(ConnectionFactoryOptions.PORT, 5432);
    }
}
```

- Use DatabaseClient
A DatabaseClient bean is auto-configured, and can be used in the beans directly via @Autowire:
```
import java.util.Map;
import reactor.core.publisher.Flux;
import org.springframework.r2dbc.core.DatabaseClient;
import org.springframework.stereotype.Component;

@Component
public class MyBean {
    private final DatabaseClient databaseClient;
    public MyBean(DatabaseClient databaseClient) {
        this.databaseClient = databaseClient;
    }
    public Flux<Map<String, Object>> someMethod() {
        return this.databaseClient.sql("select * from user").fetch().all();
    }
}
```

-  R2DBC Repositories
Similar to JpaRepository, but returns Reactive object
```
import reactor.core.publisher.Mono;
import org.springframework.data.repository.Repository;

public interface CityRepository extends Repository<City, Long> {
    Mono<City> findByNameAndStateAllIgnoringCase(String name, String state);
}
```
 
## NOSQL
Includes
- MongoDB
- Neo4J
- Elasticsearch
- Redis
- GemFire or Geode
- Cassandra
- Couchbase
- LDAP

### Redis: spring-boot-starter-data-redis
Spring Boot offers basic auto-configuration for the **Lettuce** and **Jedis** client libraries and the abstractions on top of them provided by Spring Data Redis.
- Connecting to Redis
Can inject an auto-configured **RedisConnectionFactory, StringRedisTemplate, RedisTemplate** instance in th Bean.
```
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.stereotype.Component;

@Component
public class MyBean {
    private final StringRedisTemplate template;
    public MyBean(StringRedisTemplate template) {
        this.template = template;
    }

    public Boolean someMethod() {
        return this.template.hasKey("spring");
    }
}
```

### MongoDB: spring-boot-starter-data-mongodb/spring-boot-starter-data-mongodb-reactive
Can inject an auto-configured **org.springframework.data.mongodb.MongoDatabaseFactory**:
- Connecting to a MongoDB Database
```
@Component
public class MyBean {
    private final MongoDatabaseFactory mongo;
    public MyBean(MongoDatabaseFactory mongo) {
        this.mongo = mongo;
    }

    public MongoCollection<Document> someMethod() {
        MongoDatabase db = this.mongo.getMongoDatabase();
        return db.getCollection("users");
    }
}
```
- The configurations
```
spring.data.mongodb.uri=mongodb://user:secret@mongo1.example.com:12345,mongo2.example.com:23456/test
spring.data.mongodb.host=mongoserver.example.com
spring.data.mongodb.port=27017
spring.data.mongodb.database=test
spring.data.mongodb.username=user
spring.data.mongodb.password=secret
```
- MongoTemplate
Spring Data MongoDB provides a MongoTemplate class that is very similar in its design to Spring’s JdbcTemplate
```
@Component
public class MyBean {
    private final MongoTemplate mongoTemplate;
    public MyBean(MongoTemplate mongoTemplate) {
        this.mongoTemplate = mongoTemplate;
    }

    public MongoCollection<Document> someMethod() {
        return this.mongoTemplate.getCollection("users");
    }
}
```
- Data MongoDB Repositories
Spring Data JPA and Spring Data MongoDB share the same common infrastructure, assuming that City is now a MongoDB data class (@Document) rather than a JPA @Entity. The model can be both @Document and @Entity.
```
ublic interface CityRepository extends Repository<City, Long> {
    Page<City> findAll(Pageable pageable);
    City findByNameAndStateAllIgnoringCase(String name, String state);
}
```
-  Embedded Mongo
Setup using properties *spring.mongodb.embedded*.

### Neo4j
- Connecting to a Neo4j Database
Inject an auto-configured org.neo4j.driver.Driver:
```
import org.neo4j.driver.Driver;
import org.neo4j.driver.Session;
import org.neo4j.driver.Values;
import org.springframework.stereotype.Component;

@Component
public class MyBean {
    private final Driver driver;
    public MyBean(Driver driver) {
        this.driver = driver;
    }
    public String someMethod(String message) {
        try (Session session = this.driver.session()) {
            return session.writeTransaction((transaction) -> transaction
                    .run("CREATE (a:Greeting) SET a.message = $message RETURN a.message + ', from node ' + id(a)",
                            Values.parameters("message", message))
                    .single().get(0).asString());
        }
    }
}
```
with spring.neo4j.\* properties:
```
spring.neo4j.uri=bolt://my-server:7687
spring.neo4j.authentication.username=neo4j
spring.neo4j.authentication.password=secret
```
- Data Neo4j Repositories
Spring Data includes repository support for Neo4j, similar to JPA repository with Spring Data Neo4j @Node instead of @Entity
```
public interface CityRepository extends Neo4jRepository<City, Long> {
    Optional<City> findOneByNameAndState(String name, String state);
}
```

### Solr: search engine
- Connecting to Solr
Inject an auto-configured **SolrClient** instance:
```
import java.io.IOException;
import org.apache.solr.client.solrj.SolrClient;
import org.apache.solr.client.solrj.SolrServerException;
import org.apache.solr.client.solrj.response.SolrPingResponse;
import org.springframework.stereotype.Component;

@Component
public class MyBean {
    private final SolrClient solr;
    public MyBean(SolrClient solr) {
        this.solr = solr;
    }
    public SolrPingResponse someMethod() throws SolrServerException, IOException {
        return this.solr.ping("users");
    }
}
```

### Elasticsearch: spring-boot-starter-data-elasticsearch for distributed, RESTful search and analytics engine
- Connecting to Elasticsearch using REST clients (*RestClient*)
    - low-level client: org.elasticsearch.client:elasticsearch-rest-client module with auto-configure **RestClient** bean.
    - high-level client: org.elasticsearch.client:elasticsearch-high-level-client module with auto-configured **RestHighLevelClient** bean 
```
spring.elasticsearch.uris=https://search.example.com:9200
spring.elasticsearch.socket-timeout=10s
spring.elasticsearch.username=user
spring.elasticsearch.password=secret

spring.elasticsearch.restclient.sniffer.interval=10m
spring.elasticsearch.restclient.sniffer.delay-after-failure=30s
```

- Connecting to Elasticsearch using ReactiveElasticsearchClient
Auto-configured **ReactiveElasticsearchClient** for querying Elasticsearch instances in a reactive fashion. It is built on top of WebFlux’s WebClient, with spring-boot-starter-elasticsearch and spring-boot-starter-webflux, with *spring.elasticsearch.webclient.\** properties or  custom ClientConfiguration bean:
```
spring.elasticsearch.webclient.max-in-memory-size=1MB
```
- Connecting to Elasticsearch by Using Spring Data
Inject **ElasticsearchRestTemplate** in the object:
```
import org.springframework.data.elasticsearch.core.ElasticsearchRestTemplate;
import org.springframework.stereotype.Component;

@Component
public class MyBean {
    private final ElasticsearchRestTemplate template;
    //ReactiveElasticsearchClient or ReactiveElasticsearchTemplate for Reactive
    public MyBean(ElasticsearchRestTemplate template) {
        this.template = template;
    }
    public boolean someMethod(String id) {
        return this.template.exists(id, User.class);
    }
}
```
- Spring Data Elasticsearch Repositories
Spring Data includes repository support for Elasticsearch, similar to JPA repository with Spring Data Elasticsearch @Document instead of @Entity. Spring Boot supports both classic and reactive Elasticsearch repositories, using the ElasticsearchRestTemplate or ReactiveElasticsearchTemplate beans. can add  ElasticsearchRestTemplate or ElasticsearchOperations, or ReactiveElasticsearchTemplate and ReactiveElasticsearchOperations @Bean.


### Cassandra: distributed database management system (spring-boot-starter-data-cassandra)
- Connecting to Cassandra
 Can inject an auto-configured **CassandraTemplate** or **CqlSession** instance:
 ```
import org.springframework.data.cassandra.core.CassandraTemplate;
import org.springframework.stereotype.Component;

@Component
public class MyBean {
    private final CassandraTemplate template;
    public MyBean(CassandraTemplate template) {
        this.template = template;
    }
    public long someMethod() {
        return this.template.count(User.class);
    }
}
 ```
 with **spring.data.cassandra.\*** properties:
 ```
spring.data.cassandra.port=9042
spring.data.cassandra.keyspace-name=mykeyspace
spring.data.cassandra.contact-points=cassandrahost1:9042,cassandrahost2:9042
spring.data.cassandra.local-datacenter=datacenter1
 ```
 
 - Data Cassandra Repositories
Spring Data includes basic repository support for Cassandra, with the JPA repositories annotated finder methods with **@Query**.

### Couchbase: distributed, multi-model NoSQL document-oriented database (spring-boot-starter-data-couchbase/spring-boot-starter-data-couchbase-reactive)
- Connecting to Couchbase
Get a Cluster with  **spring.couchbase.\*** properties:
```
spring.couchbase.connection-string=couchbase://192.168.1.123
spring.couchbase.username=user
spring.couchbase.password=secret

spring.couchbase.env.timeouts.connect=3s   # for ClusterEnvironment settings
spring.couchbase.env.ssl.key-store=/location/of/keystore.jks
spring.couchbase.env.ssl.key-store-password=secret
```
- Spring Data Couchbase Repositories
Can inject an auto-configured **CouchbaseTemplate**, provided a CouchbaseClientFactory bean is available:
```
import org.springframework.data.couchbase.core.CouchbaseTemplate;
import org.springframework.stereotype.Component;

@Component
public class MyBean {
    private final CouchbaseTemplate template;

    public MyBean(CouchbaseTemplate template) {
        this.template = template;
    }

    public String someMethod() {
        return this.template.getBucketName();
    }
}
```

### LDAP (spring-boot-starter-data-ldap)
- Connecting to an LDAP Server using the spring.ldap.base and spring.ldap.base-environment properties.
```
spring.ldap.urls=ldap://myserver:1235
spring.ldap.username=admin
spring.ldap.password=secret
```

- Data LDAP Repositories
Spring Data includes repository support for LDAP, inject an auto-configured **LdapTemplate** instance :
```
import java.util.List;
import org.springframework.ldap.core.LdapTemplate;
import org.springframework.stereotype.Component;

@Component
public class MyBean {
    private final LdapTemplate template;
    public MyBean(LdapTemplate template) {
        this.template = template;
    }

    public List<User> someMethod() {
        return this.template.findAll(User.class);
    }
}
```

- Embedded In-memory LDAP Server
Add dependency to com.unboundid:unboundid-ldapsdk and declare a spring.ldap.embedded.base-dn property:
```
spring.ldap.embedded.base-dn=dc=spring,dc=io
spring.ldap.embedded.base-dn[0]=dc=spring,dc=io
spring.ldap.embedded.base-dn[1]=dc=pivotal,dc=io
```

### InfluxDB: time series database optimized for fast, high-availability storage and retrieval of time series data in fields
- Connecting to InfluxDB
Spring Boot auto-configures an InfluxDB instance, provided the influxdb-java client is on the classpath and the URL of the database is set:
```
spring.influx.url=https://172.0.0.1:8086
spring.influx.user=user
spring.influx.password=password
```

InfluxDB relies on OkHttp. Register an InfluxDbOkHttpClientBuilderProvider bean to tune the behind http client InfluxDB
Registering an InfluxDbCustomizer bean provide more control over the configuration.

